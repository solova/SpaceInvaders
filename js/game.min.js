(function(p){function d(){}function f(a){this.el=a;this.x=50;this.width=5;this.move(0)}function m(a){this.width=0.25;this.y=5;this.el=e.createElement("div");this.el.className="shell";this.el.style.left=(2.5+95*a.x/100-this.width/2).toFixed(2)+"%";a.get("el").parentNode.appendChild(this.el)}function h(a){this.el=a;this.reset();this.el.style.width="90%";this.hSpeed=0.5;this.vSpeed=0.05;this.rtl=!1;this.update(0);this.length=0}function n(a){this.el=e.createElement("img");this.el.className="bug";this.el.src=
"img/bug.gif";this.replacement=e.createElement("img");this.replacement.src="img/boom.gif";this.active=!0;a.appendChild(this.el)}var e=p.document,q=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)},k=function(a){for(var b=0,j=0,g=a.offsetWidth,c=a.offsetHeight;a&&!isNaN(a.offsetLeft)&&!isNaN(a.offsetTop);)b+=a.offsetLeft-a.scrollLeft,j+=a.offsetTop-
a.scrollTop,a=a.offsetParent;return{x0:b,y0:j,x1:b+g,y1:j+c}},r="function"===typeof Audio,l=function(a){r&&e.getElementById("audio_"+a).play()};d.prototype.hitTest=function(a){var b=k(this.get("el"));a=k(a.get("el"));return!(a.x0>b.x1||a.x1<b.x0||a.y0>b.y1||a.y1<b.y0)};d.prototype.isUnder=function(a){var b=k(this.get("el"));return k(a.get("el")).y0>b.y0};d.prototype.get=function(a){return this[a]};d.prototype.set=function(a,b){this[a]=b};d.prototype.destroy=function(){this.el.parentNode.removeChild(this.el)};
f.prototype=new d;f.prototype.move=function(a){this.x+=a;100<this.x&&(this.x=100);0>this.x&&(this.x=0);this.el.style.left=(2.5+95*this.x/100-this.width/2).toFixed(2)+"%"};f.prototype.update=function(a){"undefined"!==typeof this.shell&&(this.shell.update(a),100<this.shell.get("y")&&(this.shell.destroy(),delete this.shell))};f.prototype.fire=function(){"undefined"===typeof this.shell&&(this.shell=new m(this),l("blaster"))};m.prototype=new d;m.prototype.update=function(a){this.y+=100*(a/1E3);this.el.style.bottom=
this.y.toFixed(2)+"%"};h.prototype=new d;h.prototype.reset=function(){if(this.bugs)for(var a=0,b;a<this.bugs.length;++a)b=this.bugs[a],b.destroy();this.bugs=[];this.x=this.y=0};h.prototype.update=function(a){this.y+=this.vSpeed*a/1E3;this.x=this.rtl?this.x-this.hSpeed*a/1E3:this.x+this.hSpeed*a/1E3;0>this.x&&(this.x=0,this.rtl=!1);10<this.x&&(this.x=10,this.rtl=!0);this.el.style.top=this.y.toFixed(2)+"%";this.el.style.left=this.x.toFixed(2)+"%"};n.prototype=new d;n.prototype.boom=function(){var a=
this;l("boom");this.el.src=this.replacement.src;setTimeout(function(){a.el.style.visibility="hidden"},1E3)};p.game=new function(){var a={},b,a={active:!1,updated:(new Date).getTime(),scores:0,level:0,fps:[],gameOver:function(){var a,b="undefined"!==typeof localStorage;a=b?localStorage.getItem("spaceinvaders-scores")||0:0;this.scores>a?(alertify.alert("Game Over. You score is "+this.scores+" scores. It's a new game record!"),b&&localStorage.setItem("spaceinvaders-scores",this.scores)):alertify.alert("Game Over. You score is "+
this.scores+" scores. The current game record - "+a+" scores.");this.blocks.intro.style.display="block";this.blocks.screen.style.display="none";this.bughill.reset()},bind:function(a,b,c){"function"===typeof a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,c)},addListeners:function(){this.bind(e.body,"keydown",function(a){32==a.keyCode&&(b|=1);37==a.keyCode&&(b|=2);39==a.keyCode&&(b|=4)});this.bind(e.body,"keyup",function(a){32==a.keyCode&&(b&=-2);37==a.keyCode&&(b&=
-3);39==a.keyCode&&(b&=-5)});this.bind(window,"touchstart",function(a){b=0;for(var g=window.innerWidth/2,c=0;c<a.touches.length;c++)b=a.touches[c].pageX<g?b|2:b|4});this.bind(window,"touchmove",function(a){b=0;for(var g=window.innerWidth/2,c=0;c<a.touches.length;c++)b=a.touches[c].pageX<g?b|2:b|4});this.bind(window,"touchend",function(){b=0})},blocks:{},handleKeys:function(a){b&1&&this.ship.fire();b&2&&this.ship.move(-20*a/1E3);b&4&&this.ship.move(20*a/1E3)},nextLevel:function(){this.level++;this.blocks.level.innerHTML=
this.level;var a=[];this.bughill.reset();this.bughill.set("length",30);for(var b=0;30>b;b++)a.push(new n(this.blocks.bugs));this.bughill.set("bugs",a);a=Math.pow(1.5,this.level-1);this.bughill.set("hSpeed",0.5*a);this.bughill.set("vSpeed",0.05*a)},addScores:function(a){var b=this.bughill.get("length"),c=this;a.set("active",!1);a.boom();b--;this.bughill.set("length",b);this.scores++;this.blocks.scores.innerHTML=this.scores;0==b&&(l("winner"),setTimeout(function(){c.nextLevel()},1500))},checkHits:function(){for(var a=
this.ship.get("shell"),b=this.bughill.get("bugs"),c=0,d;c<b.length;c++)if(d=b[c],d.get("active")){d.get("el");if("undefined"!==typeof a&&a.hitTest(d))return this.addScores(d),a.destroy(),delete this.ship.shell,!0;(this.ship.hitTest(d)||this.ship.isUnder(d))&&this.gameOver()}return!1},showFPS:function(a){this.fps.push(1E3/a);if(100<this.fps.length){this.fps.shift();a=0;for(var b=this.fps.length-1;0<b;b--)a+=this.fps[b];this.blocks.fps.innerHTML=(a/100).toFixed(0)}},animate:function(){var a=this,b=
(new Date).getTime(),c=b-this.updated;this.updated=b;this.handleKeys(c);this.ship.update(c);this.bughill.update(c);this.showFPS(c);this.checkHits();q(function(){a.animate()})},reset:function(){b=this.level=this.scores=0;this.updated=(new Date).getTime();this.bughill=new h(this.blocks.bugs);this.ship=new f(this.blocks.ship);this.blocks.scores.innerHTML=this.scores},start:function(){window.T=this;"function"===typeof this.init&&this.init();this.blocks.intro.style.display="none";this.blocks.screen.style.display=
"block";this.reset();this.nextLevel();this.animate();l("theme")},init:function(){for(var a=0,b="intro screen bugs ship fps level scores".split(" "),c;a<b.length;++a)c=b[a],this.blocks[c]=e.getElementById(c);this.addListeners();delete this.init}};return{start:function(){a.start()}}}})(this);